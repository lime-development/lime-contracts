name: Deploy Docs

on:
  push:
    branches:
      - main
    paths:
      - '**/*.sol'
      - '**/*.js'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install dependencies
        run: npm install

      - name: Compile contracts
        run: npx hardhat compile
        env:
          PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}

      - name: Update docs
        run: npx hardhat docgen
        env:
          PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}

      - name: Run tokenomics scripts
        run: |
          for NETWORK in haqq ethereum sepolia bnb base; do
            NETWORK=$NETWORK npx hardhat run scripts/tokenomics.js
          done
        env:
          PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}
          ALCHEMY_KEY: ${{ secrets.ALCHEMY_KEY }}

      - name: Generate index.md
        run: |
          echo "# Documentation Index" > ./docs/index.md
          echo "" >> ./docs/index.md
          for dir in $(find ./docs -type d ! -path './docs'); do
            echo "## $(basename "$dir")" >> ./docs/index.md
            for file in $(find "$dir" -maxdepth 1 -name '*.md'); do
              filename=$(basename "$file")
              name="${filename%.md}"
              echo "- [${name}](${dir#./}/$filename)" >> ./docs/index.md
            done
            echo "" >> ./docs/index.md
          done
          echo "_Updated at $(date '+%Y-%m-%d %H:%M:%S')_" >> ./docs/index.md

      - name: Import GPG key
        uses: crazy-max/ghaction-import-gpg@v6
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          passphrase: ""

      - name: Commit docs changes
        run: |
          rm -r ./docs/contracts/test || true
          rm -r ./docs/contracts/interfaces || true

          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global commit.gpgsign true
          git config --global user.signingkey $(gpg --list-secret-keys --with-colons | grep '^sec' | cut -d':' -f5)

          git add docs/
          git diff --cached --quiet || git commit -S -m "Update docs [auto]"

      - name: Push to update/docs-auto
        run: |
          git checkout -B update/docs-auto
          git push --force origin update/docs-auto

      - name: Create or Update Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Update docs [auto]"
          title: "Update docs [auto]"
          body: |
            This PR updates the autogenerated docs.

            - Regenerates contract documentation
            - Updates tokenomics data
            - Rebuilds index.md
          branch: update/docs-auto
          base: main
          draft: false
